---
title: "Load-cell calibration --- linear regression"
author: "Richard Layton"
date: '2016-08-24'
output: html_document
---

```{r, setup, include = FALSE}
library(knitr)
opts_knit$set(root.dir = '../')
opts_chunk$set(echo = TRUE)
```

# Perform the linear regression 

```{r}
# read the tidy data
library(readr)
calibr_data <- read_csv("data/02_calibr_tidy-data.csv")
head(calibr_data)
```

A linear regression relating the mV readings to the input force  produces the results we need to report the calibration equation and the sensor accuracy. 

- `input_lb` is the independent variable (*x*)
- `output_mV` is the dependent variable (*y*)

The *lm()* function creates the regression results we need:  

- slope and intercept of the linear regression
- the fitted y-values 
- the residuals 

```{r}
# perform the regression
x <- calibr_data$input_lb
y <- calibr_data$output_mV
regr_results <- lm(y ~ x)
```

# Extract relevant results 

Look at the attributes of the `lm()` results. 

```{r}
attributes(regr_results)
```

Extract the variables we need: `coefficients`, `fitted.values`, and `residuals`.  

```{r}
intercept <- regr_results$coefficients[1]
slope     <- regr_results$coefficients[2]
y_fit     <- regr_results$fitted.values
residuals <- regr_results$residuals
```

# Determine sensor accuracy

The ANSI/ISA calibration standard  defines accuracy as the maximum positive and maximum negative residual. 

```{r}
# compute accuracy in mV and as a percentage for reporting
max_resid <- max(residuals)
min_resid <- min(residuals)
```

In percentage form, accuracy is a percent of output span. The standard defines output span as the difference between the max and min y-fitted values. 

```{r}
output_span <- max(y_fit) - min(y_fit)
acc_plus    <- max_resid  / output_span * 100
acc_minus   <- min_resid / output_span * 100
```

Display the values. 

```{r, collapse = TRUE}
acc_plus
acc_minus
```

Reported accuracy is the absolute value of the largest of these two values.   

```{r}
accuracy <- max(abs(c(acc_plus, acc_minus)))
```

# Collect results 

I'd also like to record of the input range.

```{r}
input_range <- max(x) - min(x)
```

And I can collect these results in a data frame.

```{r}
# create a data frame for printing a table of results
options(digits = 2)
item <- c('input_range', 
          'output_span', 
          'slope', 
          'intercept', 
          'max_resid', 
          'min_resid', 
          'accuracy')
value  <- c(input_range, 
           output_span, 
           slope, 
           intercept, 
           max_resid, 
           min_resid, 
           accuracy)
units  <- c('lb', 
          'mV', 
          'mV/lb', 
          'mV', 
          'mV', 
          'mV', 
          '%')

calibr_results <- dplyr::data_frame(item, value, units)
calibr_results
```

# Write results to file

Save the results table to file. 

```{r}
write_csv(calibr_results, "results/03_calibr_regression_results-table.csv")
```

Add `y-fit` to the tidy data set and save it with `input_lb` and  `output_mV` for graphing later. 

```{r, message = FALSE}
library(dplyr)
graph_data <- calibr_data %>%
	mutate(fit_mV = round(y_fit, 2)) %>%
	select(input_lb, output_mV, fit_mV)
write_csv(graph_data, "results/03_calibr_regression_graph-data.csv")
```

