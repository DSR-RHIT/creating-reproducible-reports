---
title: "Load-cell calibration --- linear regression"
author: "Richard Layton"
date: '2016-08-24'
output: html_document
---

```{r 04-01, include = FALSE}
library(knitr)
opts_knit$set(root.dir = '../')
opts_chunk$set(echo = TRUE)
```

```{r 04-02, message = FALSE}
# load packages
library(readr)
suppressPackageStartupMessages(library(dplyr))
```

# Perform the linear regression 

```{r 04-03}
# read the tidy data
calibr_data <- read_csv("results/02_calibr_data-tidying.csv")
head(calibr_data)
```

A linear regression relating the mV readings to the input force  produces the results we need to report the calibration equation and the sensor accuracy. 

- `input_lb` is the independent variable (*x*)
- `output_mV` is the dependent variable (*y*)

The *lm()* function creates the regression results we need:  

- slope and intercept of the linear regression
- the fitted y-values 
- the residuals 

```{r 04-04}
# perform the regression
regr_results <- lm(output_mV ~ input_lb, data = calibr_data)
```

# Extract relevant results 

Look at the attributes of the `lm()` results. 

```{r 04-05}
attributes(regr_results)
```

The named variables we need from this list are `coefficients`, `residuals`, and `fitted.values`. Examining the structure of these three variables yields

```{r 04-06}
# Examine the three objects we want
regr_results_subset <- regr_results[c("coefficients", "residuals", "fitted.values")]
str(regr_results_subset)
```

Coefficients has 2 elements; the first is the intercept, the second is the slope. Residuals and fitted values are vectors the same length as the data set, as expected. 

Extract the variables we need: `intercept`, `slope`, `fitted.values`, and `residuals`.  

```{r 04-07}
intercept <- regr_results$coefficients[1]
slope     <- regr_results$coefficients[2]
y_fit     <- regr_results$fitted.values
residuals <- regr_results$residuals
```

# Determine sensor accuracy

The ANSI/ISA calibration standard defines accuracy as the maximum positive and maximum negative residual. 

```{r 04-08}
# determine largest absolute value residual
resid_max   <- max(residuals)
resid_min   <- abs(min(residuals))
resid_bound <- max(resid_max, resid_min)
```

In percentage form, accuracy is a percent of output span. The standard defines output span as the difference between the max and min y-fitted values. 

```{r 04-09}
output_span <- max(y_fit) - min(y_fit)
accuracy    <- resid_bound  / output_span * 100
```

Display the values. 

```{r 04-10, collapse = TRUE}
accuracy
```

# Collect results 

I'd like to collect min/max inputs and outputs in case I need them in the report. 

```{r 04-12}
input_min  <- min(calibr_data[ , 'input_lb'])
input_max  <- max(calibr_data[ , 'input_lb'])
output_min <- min(calibr_data[ , 'output_mV'])
output_max <- max(calibr_data[ , 'output_mV'])
```

Collect those results I'd like to keep handy. 

```{r 04-13}
# create a data frame for printing a table of results
options(digits = 3)
library(tibble)
calibr_results <- frame_data(
	~item,         ~value,      ~units,
	'input_min',   input_min,   'lb',
	'input_max',   input_max,   'lb',
	'output_min',  output_min,  'mV',
	'output_max',  output_max,  'mV',
	'slope',       slope,       'mV/lb',
	'intercept',   intercept,   'mV',
	'resid_bound', resid_bound, 'mV',
	'accuracy',    accuracy,    '%'
)
calibr_results <- as.data.frame(calibr_results)
calibr_results
```

# Write results to file

Save the results table to file. 

```{r 04-14}
write_csv(calibr_results, "results/04_calibr_regression-results.csv")
```

