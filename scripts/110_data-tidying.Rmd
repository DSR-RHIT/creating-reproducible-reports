---
title: "data tidying"
output:
  html_document:
    keep_md: yes
---

```{r setup, include = FALSE}
library(knitr)
opts_knit$set(root.dir = "../")
opts_chunk$set(echo = TRUE, results = 'hide', message = FALSE, warning = FALSE)
```

```{r, echo = FALSE}
# my tutorial functions for text_icon and code_icon
source("scripts/helper_02_icons.R")
```

Packages used in this tutorial  

- readr
- tidyr 
- dplyr 

How to use this tutorial 

- `r text_icon` *add text*: type the prose verbatim into the Rmd file 
- `r code_icon` *add code*: insert a code chunk then transcribe the R code 
- `r knit_icon` *Knit* after each addition. 



### open a new Rmd script

We concluded the previous script by saving a long form of the data set to file. That makes a convenient point to conclude that script and begin another to continue the analysis. 

- Open a new Rmd file, and name it `02_calibr_data-tidying.Rmd`
- Start the new script with the same YAML header as the previous script
- Change the title to `"Load-cell calibration --- tidying the data"`
- Insert the same code chunk for the knitr setup 

Knowing the packages we'll be using, we can load them right away, near the top of the file.

`r code_icon`

```{r}
# load packages
library(readr)
library(tidyr)
suppressPackageStartupMessages(library(dplyr))
```


### add a column of observation numbers

The new script starts where the old one left off. Read in the data set we saved earlier. 

`r code_icon`

```{r}
# read the long-form data file we saved in the previous step 
tidy_data <- read_csv('data/01_calibr_data-reshaping.csv')
```

`r text_icon`

    # Add a column of observation numbers

    The test points are in the order in which the data were acquired (consistent with the ANSI/ISA standard). So the observation number is the same as the row number. 

I'm not going to use the default row names as observation numbers because they are character strings, not integers. Instead, I construct an integer vector and assign it to a new column in the data frame. 

`r code_icon`

```{r, results = 'hide'}
# observation numbers are a sequence of integers, from 1 to the number of rows
nrow_in_tidy_data <- nrow(tidy_data)
tidy_data <- tidy_data %>%
	mutate(observ = 1:nrow_in_tidy_data)
head(tidy_data)
```

Learning R:

- *nrow()* returns the number of rows in the data frame
- *mutate()* creates a new column called `observ`  
- The `:` operator creates a sequence 

### check yourself

Confer with a neighbor.

1. What is the difference between the `observ` variable and the `output_mV` variable? 

### simplify the cycle number

`r text_icon`

    # simplify the cycle number

    The *cycle* data are strings, *cycle_1*, *cycle_2*, etc., from the column headings in the original data set. It might be useful omit the word "cycle" altogether and replace the data with an integer number for the cycle. 

    First, I separate the *cycle* column into two parts using the underscore in the data as the separation pattern. 

`r code_icon`

```{r}
tidy_data  <- tidy_data %>%
	separate(cycle, into = c('prefix', 'cycle'), sep = '_')
```

Learning R:

- *separate()* is a *tidyr* function that turns one column of strings into multiple columns of strings 
- `into` assigns the new column names
- `sep` assigns the character separator
- `c()` operator *combines* values into a vector

`r text_icon`

    Examine the separated columns.

`r code_icon`

```{r}
head(tidy_data)
```

### check yourself

Confer with a neighbor

1. Are the values in the `prefix` variable of any further use? 

`r text_icon`

    I can delete the new prefix column and I'll convert the cycle column from a character to an integer. 

`r code_icon`

```{r}
tidy_data <- tidy_data %>%
	select(-prefix) %>%
	mutate(cycle = as.integer(cycle))
```

- This code chunk could be read as "Overwrite `tidy_data` with `tidy_data`, then keep all columns except `prefix`, then convert the `cycle` column to integers and assign the results to the `cycle` column, overwriting the previous column."

`r code_icon`

```{r}
# Examine the results
head(tidy_data)
tail(tidy_data)
```

`r text_icon`

    Spot checking with *head()* and *tail()*, I confirm that the new cycle column is as expected. 

### final touches

`r text_icon` 

    # Final touches 
    
    The last steps in tidying this data set are to shorten the *test_point* column name and to rearrange columns in a logical order. 

`r code_icon`

```{r}
tidy_data <- tidy_data %>%
	select(observ, cycle, test_pt = test_point, input_lb, output_mV)
print(tidy_data)
```

Learning R:

- *select()* orders the columns from left to right in the order you list them
- `test_pt = test_point` inside the *select()* function renames the existing column as in `new_name = old_name`

`r text_icon`

    Write the tidy data to file in the data directory.

`r code_icon`

```{r}
write_csv(tidy_data, "results/02_calibr_data-tidying.csv")
```

### check yourself

Navigate to your results directory. it should look like this:

    results\
      `-- 02_calibr_data-tidying.csv
      
      
---
Back [data reshaping](109_data-reshaping.html)<br>
Next [calibration graph](111_calibration-graph.html)

